# 可調整參數建議 - 側邊欄控制器設計

## ✅ 重要結論：換手是真的按照參數執行！

經過代碼驗證，**目前的換手完全按照這些參數進行判斷**，不是純視覺效果！

### 證據：

1. **Line 108**: 使用 `TRIGGER_ELEVATION` (45°) 判斷是否開始換手
   ```typescript
   if (current.elevation < this.TRIGGER_ELEVATION && ...)
   ```

2. **Line 109**: 使用 `HANDOVER_COOLDOWN` (5s) 判斷冷卻時間
   ```typescript
   currentTime - this.lastHandoverTime > this.HANDOVER_COOLDOWN
   ```

3. **Line 126**: 使用 `signalQuality` 排序候選衛星
   ```typescript
   .sort((a, b) => b.signalQuality - a.signalQuality)
   ```

4. **Line 360**: 使用 **0.7** 和 **0.3** 權重計算信號品質
   ```typescript
   const signalQuality = elevationFactor * 0.7 + distanceFactor * 0.3;
   ```

5. **Line 139**: 使用 `PREPARING_ELEVATION` (30°) 判斷進入選擇階段
   ```typescript
   current.elevation < this.PREPARING_ELEVATION
   ```

**結論**：✅ 所有參數都真實影響換手邏輯，調整參數會立即改變換手行為！

---

## 🎯 推薦的側邊欄可調參數（5個最佳選擇）

從 14 個參數中精選 **5 個最重要、最直觀、效果最明顯** 的參數：

---

### ⭐ 優先級 1（必須）：核心決策參數

#### 1. **仰角權重** (Elevation Weight)

**當前值**: 70%

**UI 設計**:
```
仰角重要性: [━━━━━●━━━━] 70%
             50%         100%
說明: 仰角在換手決策中的權重（距離權重 = 100% - 仰角權重）
```

**為什麼重要**:
- ⭐⭐⭐⭐⭐ 最核心參數
- 直接決定候選衛星排序
- 調整後**立即影響**換手決策

**效果可見性**: ✅ 極高
- 調高 → 優先選擇高仰角衛星（穩定但可能較遠）
- 調低 → 優先選擇近距離衛星（信號強但可能低仰角）

**直觀程度**: ✅ 高
- 用戶理解：「仰角越重要，越優先選高位置的衛星」

**建議範圍**: 50% - 90%
- **50%**: 平衡仰角和距離
- **70%**: 當前設定（學術依據）
- **80%**: 城市環境（避免低仰角遮蔽）
- **90%**: 極端保守（幾乎只看仰角）

---

#### 2. **觸發仰角** (Trigger Elevation)

**當前值**: 45°

**UI 設計**:
```
開始換手仰角: [━━━━━●━━━━] 45°
               30°          60°
說明: 當前衛星仰角低於此值時，開始尋找新衛星
```

**為什麼重要**:
- ⭐⭐⭐⭐⭐ 決定換手時機
- 控制換手的"積極性"
- 調整後**立即改變**換手觸發時間

**效果可見性**: ✅ 極高
- 調高（如 55°）→ **更早開始換手**，換手次數增加
- 調低（如 35°）→ **延後開始換手**，換手次數減少

**直觀程度**: ✅ 極高
- 用戶理解：「數值越大，越早換手；數值越小，越晚換手」
- 配合圖示：顯示仰角示意圖

**建議範圍**: 30° - 60°
- **30°**: 激進模式（盡量減少換手）
- **40°**: 標準模式
- **45°**: 當前設定（展示模式）
- **50°**: 保守模式
- **60°**: 極端保守（提早換手）

**實時反饋**:
- 在 3D 場景中顯示當前仰角圓錐
- 觸發線可視化

---

#### 3. **冷卻時間** (Handover Cooldown)

**當前值**: 5 秒

**UI 設計**:
```
換手冷卻時間: [━━━━●━━━━━━] 5 秒
               3秒         15秒
說明: 兩次換手之間的最短間隔，防止頻繁切換
```

**為什麼重要**:
- ⭐⭐⭐⭐ 防止 Ping-Pong 換手
- 控制系統穩定性
- 影響換手頻率

**效果可見性**: ✅ 高
- 調短（如 3s）→ 換手更頻繁，反應更靈敏
- 調長（如 12s）→ 換手較少，更穩定

**直觀程度**: ✅ 極高
- 用戶理解：「冷卻時間越長，換手越不頻繁」
- 類比：遊戲中的技能冷卻

**建議範圍**: 3s - 15s
- **3s**: 快速反應模式
- **5s**: 當前設定（平衡）
- **10s**: 穩定模式
- **12s**: 與 RSRP 方法對齊
- **15s**: 極端穩定

**實時反饋**:
- 顯示冷卻剩餘時間條
- 冷卻中時圖標變暗

---

### ⭐ 優先級 2（推薦）：視覺與體驗

#### 4. **換手動畫速度** (Handover Animation Speed)

**當前值**: 正常速度（總計 50 秒）

**UI 設計**:
```
換手速度: ⚪ 快速  ⚫ 正常  ⚪ 慢速  ⚪ 自訂
```

**選項**:

| 模式 | 總時間 | 各階段時間 | 適用場景 |
|-----|--------|-----------|---------|
| **極快** | 5s | 1/0.5/2/1/0.5 | 真實模擬 |
| **快速** | 12s | 3/2/3/3/1 | 快速展示 |
| **正常** | 50s | 12/10/12/12/4 | 詳細教學（當前） |
| **慢速** | 80s | 20/15/20/20/5 | 深入分析 |
| **自訂** | - | 手動設定 | 高級用戶 |

**為什麼重要**:
- ⭐⭐⭐ 影響展示效果
- 不影響換手邏輯
- 方便不同使用場景

**效果可見性**: ✅ 極高（立即可見）

**直觀程度**: ✅ 極高
- 用戶理解：速度快慢一目了然

---

#### 5. **候選衛星數量** (Candidate Count)

**當前值**: 6 顆

**UI 設計**:
```
顯示候選數量: [━━━━━●━━━━] 6 顆
               3顆         10顆
說明: 準備階段顯示的候選衛星數量（僅影響視覺）
```

**為什麼重要**:
- ⭐⭐⭐ 影響視覺豐富度
- 不影響換手決策（只選最佳）
- 方便觀察更多候選

**效果可見性**: ✅ 高
- 調整後立即看到虛線數量變化

**直觀程度**: ✅ 高
- 用戶理解：「看到更多/更少候選線」

**建議範圍**: 3 - 10 顆
- **3**: 簡潔模式
- **6**: 當前設定（平衡）
- **10**: 詳細模式

---

### ⭐ 優先級 3（可選）：進階參數

#### 6. **準備仰角** (Preparing Elevation)

**當前值**: 30°

**為什麼不推薦放在基礎控制**:
- ⚠️ 較技術性，對普通用戶不直觀
- ⚠️ 與「觸發仰角」概念重疊，容易混淆
- ✅ 可放在「高級設定」摺疊區

#### 7. **執行仰角** (Execute Elevation)

**當前值**: 20°

**為什麼不推薦放在基礎控制**:
- ⚠️ 過於技術，需要理解換手階段
- ⚠️ 調整效果不明顯
- ✅ 可放在「高級設定」摺疊區

---

## 📐 UI 設計建議（Mockup）

### 側邊欄佈局

```
┌─────────────────────────────────┐
│  ⚙️ 換手參數調整                │
├─────────────────────────────────┤
│                                 │
│  🎯 核心決策參數                 │
│                                 │
│  仰角重要性                      │
│  [━━━━━●━━━━] 70%              │
│  └─ 影響：優先選擇高仰角衛星      │
│                                 │
│  開始換手仰角                    │
│  [━━━━━●━━━━] 45°              │
│  └─ 影響：越大越早開始換手        │
│                                 │
│  換手冷卻時間                    │
│  [━━━━●━━━━━━] 5秒             │
│  └─ 影響：防止頻繁換手            │
│                                 │
├─────────────────────────────────┤
│                                 │
│  🎨 視覺效果                     │
│                                 │
│  換手速度                        │
│  ⚪ 快速  ⚫ 正常  ⚪ 慢速      │
│                                 │
│  候選數量                        │
│  [━━━━━●━━━━] 6顆              │
│                                 │
├─────────────────────────────────┤
│                                 │
│  🔽 高級設定（點擊展開）          │
│                                 │
├─────────────────────────────────┤
│                                 │
│  [重置為預設值]  [套用變更]      │
│                                 │
└─────────────────────────────────┘
```

---

## 🎨 視覺反饋建議

### 1. 實時數值顯示
```typescript
// 滑桿上方顯示當前值
仰角重要性: 70% (距離: 30%)
            ↑ 實時更新
```

### 2. 效果預覽
```typescript
// 調整參數時，在 3D 場景中顯示：
- 觸發仰角線（半透明圓錐）
- 當前仰角指示器
- 候選衛星高亮
```

### 3. 統計面板
```typescript
// 顯示調整後的效果：
┌─────────────────────┐
│  當前設定影響預估     │
├─────────────────────┤
│  換手頻率: ⬇️ 降低 15% │
│  穩定性: ⬆️ 提升      │
│  反應速度: ➡️ 不變    │
└─────────────────────┘
```

---

## 🔧 技術實現建議

### 1. 參數狀態管理

```typescript
interface GeometricHandoverConfig {
  // 核心參數
  elevationWeight: number;     // 0.5 - 0.9
  triggerElevation: number;    // 30 - 60 (度)
  handoverCooldown: number;    // 3 - 15 (秒)

  // 視覺參數
  animationSpeed: 'fast' | 'normal' | 'slow' | 'custom';
  candidateCount: number;      // 3 - 10

  // 高級參數（可選）
  preparingElevation?: number; // 20 - 50 (度)
  executeElevation?: number;   // 10 - 30 (度)
}

// 預設值
const DEFAULT_CONFIG: GeometricHandoverConfig = {
  elevationWeight: 0.7,
  triggerElevation: 45,
  handoverCooldown: 5,
  animationSpeed: 'normal',
  candidateCount: 6
};
```

### 2. 預設配置

```typescript
const PRESET_CONFIGS = {
  conservative: {
    name: '保守模式',
    desc: '減少換手，優先穩定',
    elevationWeight: 0.8,
    triggerElevation: 35,
    handoverCooldown: 10
  },
  balanced: {
    name: '平衡模式',
    desc: '當前推薦設定',
    elevationWeight: 0.7,
    triggerElevation: 45,
    handoverCooldown: 5
  },
  aggressive: {
    name: '激進模式',
    desc: '快速反應，頻繁換手',
    elevationWeight: 0.6,
    triggerElevation: 50,
    handoverCooldown: 3
  },
  academic: {
    name: '學術模式',
    desc: '符合 He et al. (2020)',
    elevationWeight: 0.7,
    triggerElevation: 50,
    handoverCooldown: 12
  }
};
```

### 3. 參數驗證

```typescript
function validateConfig(config: GeometricHandoverConfig): boolean {
  // 權重總和必須為 1
  const distanceWeight = 1 - config.elevationWeight;

  // 仰角範圍檢查
  if (config.triggerElevation < 30 || config.triggerElevation > 60) {
    return false;
  }

  // 冷卻時間檢查
  if (config.handoverCooldown < 3 || config.handoverCooldown > 15) {
    return false;
  }

  return true;
}
```

### 4. 實時應用

```typescript
// 在 EnhancedHandoverManager 中
class EnhancedHandoverManager {
  private config: GeometricHandoverConfig;

  updateConfig(newConfig: Partial<GeometricHandoverConfig>) {
    this.config = { ...this.config, ...newConfig };

    // 立即重新計算 metrics
    this.recalculateMetrics();
  }

  private calculateMetrics(visibleSatellites: Map<string, THREE.Vector3>) {
    // 使用動態權重
    const signalQuality =
      elevationFactor * this.config.elevationWeight +
      distanceFactor * (1 - this.config.elevationWeight);
  }
}
```

---

## 📊 參數影響對照表

| 參數 | 調高效果 | 調低效果 | 最明顯變化 |
|-----|---------|---------|-----------|
| **仰角權重** | 優先高仰角衛星 | 優先近距離衛星 | 候選排序變化 |
| **觸發仰角** | 更早開始換手 | 更晚開始換手 | 換手次數變化 ⭐ |
| **冷卻時間** | 換手較少 | 換手頻繁 | 換手頻率變化 ⭐ |
| **動畫速度** | 快速切換 | 慢速展示 | 視覺速度 ⭐ |
| **候選數量** | 線條變多 | 線條變少 | 虛線數量 |

⭐ = 效果最明顯

---

## 🎯 最終推薦：5 個參數

根據重要性、直觀性、效果可見性的綜合評估：

### 必須包含（3個）：
1. ✅ **仰角重要性** - 最核心，影響最大
2. ✅ **開始換手仰角** - 最直觀，效果最明顯
3. ✅ **換手冷卻時間** - 防止頻繁換手，易理解

### 推薦包含（2個）：
4. ✅ **換手速度** - 視覺效果，立即可見
5. ✅ **候選數量** - 視覺豐富度，簡單直觀

### 可選（高級設定）：
6. ⚪ **準備仰角** - 較技術
7. ⚪ **執行仰角** - 較技術
8. ⚪ **最大距離** - 歸一化參數，不直觀

---

## 💡 用戶體驗優化建議

### 1. 工具提示（Tooltip）
```typescript
// 滑鼠懸停時顯示：
仰角重要性: 70%
ℹ️ 決定換手時優先選擇高仰角還是近距離的衛星
   • 數值越高：越優先選擇高仰角衛星（更穩定）
   • 數值越低：越優先選擇近距離衛星（信號更強）

   當前設定基於學術論文 He et al. (2020)
```

### 2. 預設配置快速切換
```typescript
// 下拉選單：
┌─────────────────────┐
│ ⚙️ 快速配置           │
├─────────────────────┤
│ ⚫ 平衡模式（當前）    │
│ ⚪ 保守模式          │
│ ⚪ 激進模式          │
│ ⚪ 學術模式          │
│ ⚪ 自訂...           │
└─────────────────────┘
```

### 3. 變更警示
```typescript
// 當參數偏離推薦值時：
⚠️ 警告：觸發仰角設為 25° 可能導致換手過晚
💡 建議：保持在 35°-55° 範圍內
```

### 4. 比較模式
```typescript
// 允許用戶比較不同配置：
┌─────────────────────────────────┐
│  配置 A    vs    配置 B          │
├─────────────────────────────────┤
│  70% 仰角  <->  60% 仰角         │
│  45° 觸發  <->  40° 觸發         │
│  5s 冷卻   <->  10s 冷卻         │
├─────────────────────────────────┤
│  預估換手: 23次  vs  18次        │
└─────────────────────────────────┘
```

---

## 📚 相關文檔更新

需要同步更新的文檔：
1. `/doc/USER_GUIDE.md` - 添加參數調整說明章節
2. `/doc/GEOMETRIC_HANDOVER_PARAMETERS.md` - 添加 UI 使用指南
3. 新增：`/doc/PARAMETER_TUNING_GUIDE.md` - 參數調優指南

---

**總結**：
- ✅ **換手是真的按參數執行**，不是純視覺
- ✅ 推薦 **5 個最直觀的參數**讓使用者調整
- ✅ 其中 **3 個核心參數**影響決策，**2 個視覺參數**改善體驗
- ✅ 效果都是**立即可見**的

---

**版本**: 1.0.0
**日期**: 2025-12-04
**建議實作順序**: 核心參數 → 視覺參數 → 高級設定 → 預設配置
